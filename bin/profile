#!/bin/bash

tmp_aliases=$(mktemp -t XXXXXX)

for pth_config in config/*; do
	[[ -f $pth_config ]] || continue
	source $pth_config

	pth_vagrant=$(pwd)/vagrant/$vagrantname
	[[ -d $pth_vagrant ]] || continue

  nm_vagrant="${pth_config##*/}"
  cat >> $tmp_aliases << EOF
  function $nm_vagrant {
    export VAGRANT_VM_NETWORK=\$PANCAKE_NETWORK.\$${nm_vagrant}_ip

    pushd $(pwd) > /dev/null
    case "\$1" in
      ssh_config)
        bin/vagrant $nm_vagrant ssh_config | sed "s#Host default#Host $nm_vagrant \$PANCAKE_NETWORK.\$${nm_vagrant}_ip#"
        echo "  ForwardAgent yes"
        ;;
      up)
        bin/vagrant $nm_vagrant up \$PANCAKE_NETWORK.\$${nm_vagrant}_ip
        ;;
      destroy)
        bin/vagrant $nm_vagrant destroy
        ;;
      *)
        bin/vagrant $nm_vagrant ssh "\$@"
        ;;
    esac
    popd > /dev/null
  }
EOF
done
unset pth_vagrant

source $tmp_aliases
rm -f $tmp_aliases

