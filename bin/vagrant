#!/bin/bash -e

nm_instance=$1; shift
nm_cmd=$1; shift
bin/bundler

pushd vagrant/$nm_instance > /dev/null

pth_config="$(pwd)/.ssh_config"

if [[ .vagrant -nt $pth_config ]]; then
  bundle exec vagrant ssh_config > $pth_config
  echo "UserKnownHostsFile=.ssh_known_hosts" >> $pth_config
fi


if [[ .vagrant -nt .ssh_known_hosts ]]; then
  port=$(awk '$1 == "Port" { print $2 }' $pth_config)
  hostname=$(awk '$1 == "HostName" { print $2 }' $pth_config)
  ssh-keyscan -p $port $hostname,"[$hostname]:$port" 2>&- > .ssh_known_hosts
fi

popd > /dev/null

case "$nm_cmd" in
  ssh)   ssh -F $pth_config                     default "$@" ;;
  scp)   scp -F $pth_config                "$1" default:"$2" ;;
  rsync) rsync -ia -e "ssh -F $pth_config" "$1" default:"$2" ;;

  *)     
    cd vagrant/$nm_instance
    bundle exec vagrant "$nm_cmd" "$@" 
  ;;
esac
