#!/bin/bash -e

if [[ -n $1 && -z $2 ]]; then
  set "$@" ssh
fi

case "$1" in
  ssh|scp|rsync)
    nm_cmd=$1; shift
    nm_instance=$1; shift
  ;;
  *)
    nm_instance=$1; shift
    nm_cmd="vagrant"
  ;;
esac

source .profile
bin/bundler

pushd vagrant/$nm_instance > /dev/null

pth_config="$(pwd)/.ssh_config"

if [[ .vagrant -nt $pth_config ]]; then
  bundle exec vagrant ssh-config | egrep -v '/dev/null' | perl -pe "s{Host default}{Host $nm_instance}" > $pth_config
  echo "  UserKnownHostsFile=$(pwd)/.ssh_known_hosts" >> $pth_config
fi

if [[ .vagrant -nt .ssh_known_hosts ]]; then
  port=$(awk '$1 == "Port" { print $2 }' $pth_config)
  hostname=$(awk '$1 == "HostName" { print $2 }' $pth_config)
  ssh-keyscan -p $port $hostname,$nm_instance,"[$hostname]:$port" 2>&- > .ssh_known_hosts
fi

popd > /dev/null

case "$nm_cmd" in
  ssh)   ssh -F $pth_config   $nm_instance "$@" ;;
  scp)   scp -F $pth_config                "$@" ;;
  rsync) rsync -ia -e "ssh -F $pth_config" "$@" ;;

  vagrant)     
    cd vagrant/$nm_instance
    bundle exec vagrant "$@" 
  ;;
esac
