#!/bin/bash -e

nm_instance=$1; shift
nm_cmd=$1; shift

bin/bundler

cd vagrant/$nm_instance

tmp_config=$(mktemp -t XXXXXXXXX)
bundle exec vagrant ssh_config > $tmp_config
echo "UserKnownHostsFile=.ssh_known_hosts" >> $tmp_config

if [[ .vagrant -nt .ssh_known_hosts ]]; then
  tmp_vagrant=$(mktemp -t XXXXXXXXX)
  bundle exec vagrant ssh_config > $tmp_vagrant

  port=$(awk '$1 == "Port" { print $2 }' $tmp_vagrant)
  hostname=$(awk '$1 == "HostName" { print $2 }' $tmp_vagrant)

  rm -f $tmp_vagrant

  ssh-keyscan -p $port $hostname,"[$hostname]:$port" 2>&- > .ssh_known_hosts
fi

cd - > /dev/null

case "$nm_cmd" in
  ssh)   ssh -F $tmp_config                     default "$@" ;;
  scp)   scp -F $tmp_config                "$1" default:"$2" ;;
  rsync) rsync -ia -e "ssh -F $tmp_config" "$1" default:"$2" ;;

  *)     bundle exec vagrant "$@" ;;
esac

rm -f $tmp_config
