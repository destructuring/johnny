#!/bin/bash -e

nm_base=$1; shift
nm_instance=$1; shift
export ip_instance=$1; shift
bin/bundler

figlet "start vagrant"
pushd vagrant/$nm_instance > /dev/null
bundle exec vagrant destroy || true
bundle exec vagrant up
popd > /dev/null

figlet "vbox"
cat | bin/vagrant ssh $nm_instance bash - << "EOF"
aptitude install -y linux-headers-$(uname -r)

tmp_vguest=$(mktemp -t XXXXXXXXX)

VBOX_VERSION=$(cat ~/.vbox_version)
wget -O $tmp_vguest http://download.virtualbox.org/virtualbox/$VBOX_VERSION/VBoxGuestAdditions_$VBOX_VERSION.iso

mount -o loop $tmp_vguest /mnt
sh /mnt/VBoxLinuxAdditions.run
umount /mnt

rm -f $tmp_vguest
EOF
bin/vagrant $nm_instance reload

figlet "seeding"
rsync -ia ~/.ssh/authorized_keys vagrant/$nm_instance/.ssh_authorized_keys
rsync -ia definitions/$nm_base/vagrant/. vagrant/$nm_instance/
perl -pe 'm{config.vm.network} && s{config.vm.network.*}{config.vm.network "$ENV{ip_instance}"}' -i vagrant/$nm_instance/Vagrantfile

figlet "postinstall"
bin/vagrant ssh $nm_instance /vagrant/postinstall.sh $nm_instance
bin/vagrant $nm_instance reload
