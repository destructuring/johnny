#!/bin/bash -e

nm_base=$1; shift
nm_instance=$1; shift
export ip_instance=$1; shift
bin/bundler

figlet "start vagrant"
rsync -ia definitions/$nm_base/vagrant/. vagrant/$nm_instance/
perl -pe 'm{config.vm.network} && s{config.vm.network.*}{config.vm.network "$ENV{ip_instance}"}' -i vagrant/$nm_instance/Vagrantfile

#bin/vagrant $nm_instance destroy || true
bin/vagrant $nm_instance up
rsync -ia ~/.ssh/authorized_keys vagrant/$nm_instance/.ssh_authorized_keys

bin/setup-guest-additions $nm_instance

figlet "postinstall"
bin/vagrant ssh $nm_instance /vagrant/postinstall.sh $nm_instance
