#!/bin/bash -e

figlet "ubuntu bundle"
bundle config build.nokogiri --with-xslt-dir=/opt/zendesk/macports/local
bundle check || bundle --local --path vendor/bundle

tmp_veewee=$(mktemp -t XXXXXX)

for a in "$@"; do
  source "config/${a}"
  export veewee_name vagrant_name

	nm_build=$(basename $(cat definitions/${veewee_name}/definition.rb  | grep iso_file | cut -d'"' -f2) .iso) # TODO weak
  url_build=$(cat definitions/${veewee_name}/definition.rb  | grep iso_src | cut -d'"' -f2) # TODO weak

  figlet "download iso"
  wget -c "$url_build" -O "iso/$nm_build.download.iso" # 404 does not return error code
  [[ -s "iso/$nm_build.download.iso" ]] || exit 1

  if [[ ! -d "iso/$nm_build.src" ]]; then
    figlet "unpack iso"
    hdiutil mount -mountpoint "$(pwd)/iso/$nm_build.mnt" "iso/$nm_build.download.iso"
    sudo rsync -ia "iso/$nm_build.mnt/." "iso/$nm_build.src/"
    sudo chown -R $(id -un):$(id -gn) "iso/$nm_build.src"
    hdiutil unmount "$(pwd)/iso/$nm_build.mnt"
  fi

  figlet "build install"
  bin/build-ubuntu $a

  echo $veewee_name >> $tmp_veewee
done

for veewee_name in $(cat $tmp_veewee | sort -u); do
  bundle exec vagrant box remove "$veewee_name" 2>&1 || VBoxManage unregistervm $veewee_name --delete || true
  bundle exec vagrant basebox build "$veewee_name" -f -n

  rm -f "$veewee_name.box"
  bundle exec vagrant basebox export "$veewee_name"
done

rm -f $tmp_veewee

for a in "$@"; do
  figlet "building $a"

  source "config/${a}"
  export veewee_name vagrant_name

  figlet "build vagrant"
  bin/build-vagrant $a -f

  bin/setup-vagrant "$a"
done


