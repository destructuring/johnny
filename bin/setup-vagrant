#!/bin/bash -e

nm_base=$1; shift
nm_instance=$1; shift
export ip_instance=$1; shift
source "config/$nm_base"
bin/bundler

rsync -ia definitions/$nm_base/vagrant/. vagrant/$nm_instance/
cd vagrant/$nm_instance
perl -pe 'm{config.vm.network} && s{config.vm.network.*}{config.vm.network "$ENV{ip_instance}"}' -i Vagrantfile

figlet "start vagrant"
bundle exec vagrant destroy || true
bundle exec vagrant up

cd - > /dev/null
figlet "postinstall"
bin/vagrant $nm_instance rsync vagrant/$nm_instance/postinstall.sh postinstall.sh
bin/vagrant $nm_instance ssh ./postinstall.sh vagrant
