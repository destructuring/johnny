#!/bin/bash -e

nm_base=$1; shift
source "config/$nm_base"
bin/bundler

nm_build=$(basename $(cat definitions/$veewee_name/definition.rb  | grep iso_file | cut -d'"' -f2) .iso) # TODO weak

mkdir -p iso/$nm_build.src/{preseed,isolinux}
chmod u+w iso/$nm_build.src/{preseed,isolinux}
chmod u+w iso/$nm_build.src/isolinux/isolinux.bin

rsync -ia definitions/$veewee_name/preseed.cfg iso/$nm_build.src/preseed/
rsync -ia definitions/$veewee_name/isolinux.cfg iso/$nm_build.src/isolinux/

figlet "build installer"
pth_iso="$(pwd)/iso/$nm_build.iso"
cd iso/$nm_build.src
mkisofs \
  -r -V "$nm_build" \
  -cache-inodes -J -l -b isolinux/isolinux.bin -c isolinux/boot.cat \
  -no-emul-boot -boot-load-size 4 -boot-info-table -o "$pth_iso" .

